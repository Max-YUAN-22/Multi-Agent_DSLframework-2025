<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent DSL Framework - 虚拟实例演示</title>
    <link rel="stylesheet" href="virtual-demo.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>Multi-Agent DSL Framework</h1>
            <p class="subtitle">虚拟实例演示 / Virtual Demo</p>
            <p class="description">无需部署即可体验系统功能</p>
        </div>
    </header>

    <main>
        <section class="demo-controls">
            <div class="container">
                <h2>系统控制面板 / System Control Panel</h2>
                <div class="control-grid">
                    <div class="control-card">
                        <h3>事件模拟器 / Event Simulator</h3>
                        <div class="simulator-controls">
                            <button id="startSimulation" class="btn btn-primary">开始模拟 / Start Simulation</button>
                            <button id="stopSimulation" class="btn btn-secondary" disabled>停止模拟 / Stop Simulation</button>
                            <button id="sendEvent" class="btn btn-accent">发送事件 / Send Event</button>
                        </div>
                        <div class="event-stats">
                            <div class="stat-item">
                                <span class="stat-label">已发送事件 / Events Sent:</span>
                                <span class="stat-value" id="eventsSent">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">处理中 / Processing:</span>
                                <span class="stat-value" id="processing">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">已完成 / Completed:</span>
                                <span class="stat-value" id="completed">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="control-card">
                        <h3>智能体状态 / Agent Status</h3>
                        <div class="agent-grid">
                            <div class="agent-item" data-agent="perception">
                                <div class="agent-icon">👁️</div>
                                <div class="agent-info">
                                    <h4>感知智能体 / Perception Agent</h4>
                                    <div class="agent-status active">活跃 / Active</div>
                                </div>
                            </div>
                            <div class="agent-item" data-agent="safety">
                                <div class="agent-icon">🛡️</div>
                                <div class="agent-info">
                                    <h4>安全智能体 / Safety Agent</h4>
                                    <div class="agent-status active">活跃 / Active</div>
                                </div>
                            </div>
                            <div class="agent-item" data-agent="traffic">
                                <div class="agent-icon">🚦</div>
                                <div class="agent-info">
                                    <h4>交通智能体 / Traffic Agent</h4>
                                    <div class="agent-status active">活跃 / Active</div>
                                </div>
                            </div>
                            <div class="agent-item" data-agent="reroute">
                                <div class="agent-icon">🗺️</div>
                                <div class="agent-info">
                                    <h4>重路由智能体 / Reroute Agent</h4>
                                    <div class="agent-status standby">待机 / Standby</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="real-time-visualization">
            <div class="container">
                <h2>实时可视化 / Real-time Visualization</h2>
                <div class="visualization-grid">
                    <div class="chart-container">
                        <h3>事件处理延迟 / Event Processing Latency</h3>
                        <div class="chart" id="latencyChart">
                            <div class="chart-placeholder">
                                <div class="chart-line"></div>
                                <div class="chart-line"></div>
                                <div class="chart-line"></div>
                                <div class="chart-line"></div>
                                <div class="chart-line"></div>
                            </div>
                            <div class="chart-labels">
                                <span>0ms</span>
                                <span>100ms</span>
                                <span>200ms</span>
                                <span>300ms</span>
                                <span>400ms</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>缓存命中率 / Cache Hit Rate</h3>
                        <div class="chart" id="cacheChart">
                            <div class="cache-meter">
                                <div class="cache-fill" id="cacheFill"></div>
                                <div class="cache-text" id="cacheText">85%</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>吞吐量 / Throughput</h3>
                        <div class="chart" id="throughputChart">
                            <div class="throughput-bars">
                                <div class="bar" style="height: 60%"></div>
                                <div class="bar" style="height: 80%"></div>
                                <div class="bar" style="height: 45%"></div>
                                <div class="bar" style="height: 90%"></div>
                                <div class="bar" style="height: 70%"></div>
                                <div class="bar" style="height: 85%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="event-log">
            <div class="container">
                <div class="log-header-section">
                    <h2>📊 交互历史 / Interaction History</h2>
                    <div class="log-controls">
                        <button id="clearLog" class="btn btn-small">清空日志 / Clear Log</button>
                        <button id="exportLog" class="btn btn-small">导出数据 / Export Data</button>
                        <div class="log-filter">
                            <select id="statusFilter">
                                <option value="all">所有状态 / All Status</option>
                                <option value="completed">已完成 / Completed</option>
                                <option value="processing">处理中 / Processing</option>
                                <option value="pending">等待中 / Pending</option>
                                <option value="failed">失败 / Failed</option>
                            </select>
                        </div>
                        <div class="log-search">
                            <input type="text" id="logSearch" placeholder="搜索事件... / Search events...">
                        </div>
                    </div>
                </div>
                <div class="log-container">
                    <div class="log-header">
                        <span class="sortable" data-sort="time">时间 / Time ⏰</span>
                        <span class="sortable" data-sort="type">事件类型 / Event Type 📋</span>
                        <span class="sortable" data-sort="agent">智能体 / Agent 🤖</span>
                        <span class="sortable" data-sort="status">状态 / Status 🎯</span>
                        <span class="sortable" data-sort="latency">延迟 / Latency ⚡</span>
                        <span>操作 / Actions 🔧</span>
                    </div>
                    <div class="log-content" id="logContent">
                        <div class="log-entry" data-status="completed" data-type="traffic" data-agent="perception">
                            <span class="time">14:32:15</span>
                            <span class="event-type">
                                <span class="event-icon">🚗</span>
                                Traffic Incident
                            </span>
                            <span class="agent">
                                <span class="agent-icon">👁️</span>
                                Perception
                            </span>
                            <span class="status completed">
                                <span class="status-icon">✅</span>
                                Completed
                            </span>
                            <span class="latency good">45ms</span>
                            <span class="actions">
                                <button class="action-btn" onclick="viewEventDetails('evt_001')" title="查看详情 / View Details">👁️</button>
                                <button class="action-btn" onclick="replayEvent('evt_001')" title="重放 / Replay">🔄</button>
                            </span>
                        </div>
                        <div class="log-entry" data-status="processing" data-type="safety" data-agent="safety">
                            <span class="time">14:32:18</span>
                            <span class="event-type">
                                <span class="event-icon">⚠️</span>
                                Safety Alert
                            </span>
                            <span class="agent">
                                <span class="agent-icon">🛡️</span>
                                Safety
                            </span>
                            <span class="status processing">
                                <span class="status-icon">⏳</span>
                                Processing
                            </span>
                            <span class="latency">-</span>
                            <span class="actions">
                                <button class="action-btn" onclick="viewEventDetails('evt_002')" title="查看详情 / View Details">👁️</button>
                                <button class="action-btn" onclick="cancelEvent('evt_002')" title="取消 / Cancel">❌</button>
                            </span>
                        </div>
                        <div class="log-entry" data-status="pending" data-type="route" data-agent="reroute">
                            <span class="time">14:32:20</span>
                            <span class="event-type">
                                <span class="event-icon">🗺️</span>
                                Route Update
                            </span>
                            <span class="agent">
                                <span class="agent-icon">🔄</span>
                                Reroute
                            </span>
                            <span class="status pending">
                                <span class="status-icon">⏸️</span>
                                Pending
                            </span>
                            <span class="latency">-</span>
                            <span class="actions">
                                <button class="action-btn" onclick="viewEventDetails('evt_003')" title="查看详情 / View Details">👁️</button>
                                <button class="action-btn" onclick="prioritizeEvent('evt_003')" title="优先处理 / Prioritize">⚡</button>
                            </span>
                        </div>
                    </div>
                    <div class="log-summary">
                        <div class="summary-stats">
                            <span class="summary-item">
                                <span class="summary-label">总事件 / Total Events:</span>
                                <span class="summary-value" id="totalEvents">3</span>
                            </span>
                            <span class="summary-item">
                                <span class="summary-label">成功率 / Success Rate:</span>
                                <span class="summary-value" id="successRate">95.2%</span>
                            </span>
                            <span class="summary-item">
                                <span class="summary-label">平均延迟 / Avg Latency:</span>
                                <span class="summary-value" id="avgLatency">67ms</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="performance-metrics">
            <div class="container">
                <h2>性能指标 / Performance Metrics</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon">⚡</div>
                        <div class="metric-info">
                            <h3>平均延迟 / Avg Latency</h3>
                            <div class="metric-value" id="avgLatency">67ms</div>
                            <div class="metric-trend positive">↓ 12%</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">🎯</div>
                        <div class="metric-info">
                            <h3>缓存命中率 / Cache Hit Rate</h3>
                            <div class="metric-value" id="cacheHitRate">85%</div>
                            <div class="metric-trend positive">↑ 5%</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">📊</div>
                        <div class="metric-info">
                            <h3>吞吐量 / Throughput</h3>
                            <div class="metric-value" id="throughput">1,247/min</div>
                            <div class="metric-trend positive">↑ 8%</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">✅</div>
                        <div class="metric-info">
                            <h3>成功率 / Success Rate</h3>
                            <div class="metric-value" id="successRate">98.7%</div>
                            <div class="metric-trend positive">↑ 2%</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Multi-Agent DSL Framework. 多智能体领域特定语言框架项目</p>
            <p><a href="../index.html">返回主页 / Back to Home</a></p>
        </div>
    </footer>

    <script>
        // 模拟数据更新
        let simulationRunning = false;
        let eventCounter = 0;
        let processingCounter = 0;
        let completedCounter = 0;

        const eventTypes = ['Traffic Incident', 'Safety Alert', 'Route Update', 'Weather Change', 'Emergency'];
        const agents = ['Perception', 'Safety', 'Traffic', 'Reroute', 'Weather'];
        const statuses = ['Pending', 'Processing', 'Completed'];

        function updateStats() {
            document.getElementById('eventsSent').textContent = eventCounter;
            document.getElementById('processing').textContent = processingCounter;
            document.getElementById('completed').textContent = completedCounter;
        }

        function addLogEntry() {
            const logContent = document.getElementById('logContent');
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];
            const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
            const agent = agents[Math.floor(Math.random() * agents.length)];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            const latency = status === 'Completed' ? Math.floor(Math.random() * 200) + 20 + 'ms' : '-';
            const eventId = 'evt_' + Date.now();

            // 事件图标映射
            const eventIcons = {
                'Traffic Incident': '🚗',
                'Safety Alert': '⚠️',
                'Route Update': '🗺️',
                'Weather Change': '🌤️',
                'Emergency': '🚨'
            };

            // 智能体图标映射
            const agentIcons = {
                'Perception': '👁️',
                'Safety': '🛡️',
                'Traffic': '🚦',
                'Reroute': '🔄',
                'Weather': '🌦️'
            };

            // 状态图标映射
            const statusIcons = {
                'Completed': '✅',
                'Processing': '⏳',
                'Pending': '⏸️'
            };

            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.setAttribute('data-status', status.toLowerCase());
            entry.setAttribute('data-type', eventType.toLowerCase().replace(' ', '-'));
            entry.setAttribute('data-agent', agent.toLowerCase());
            entry.innerHTML = `
                <span class="time">${time}</span>
                <span class="event-type">
                    <span class="event-icon">${eventIcons[eventType]}</span>
                    ${eventType}
                </span>
                <span class="agent">
                    <span class="agent-icon">${agentIcons[agent]}</span>
                    ${agent}
                </span>
                <span class="status ${status.toLowerCase()}">
                    <span class="status-icon">${statusIcons[status]}</span>
                    ${status}
                </span>
                <span class="latency ${status === 'Completed' ? 'good' : ''}">${latency}</span>
                <span class="actions">
                    <button class="action-btn" onclick="viewEventDetails('${eventId}')" title="查看详情 / View Details">👁️</button>
                    ${status === 'Completed' ? `<button class="action-btn" onclick="replayEvent('${eventId}')" title="重放 / Replay">🔄</button>` : ''}
                    ${status === 'Processing' ? `<button class="action-btn" onclick="cancelEvent('${eventId}')" title="取消 / Cancel">❌</button>` : ''}
                    ${status === 'Pending' ? `<button class="action-btn" onclick="prioritizeEvent('${eventId}')" title="优先处理 / Prioritize">⚡</button>` : ''}
                </span>
            `;

            logContent.insertBefore(entry, logContent.firstChild);
            
            // 保持最多20条记录
            if (logContent.children.length > 20) {
                logContent.removeChild(logContent.lastChild);
            }

            // 更新统计信息
            updateLogSummary();
        }

        function updateMetrics() {
            // 更新缓存命中率
            const cacheRate = 80 + Math.random() * 15;
            document.getElementById('cacheHitRate').textContent = Math.round(cacheRate) + '%';
            document.getElementById('cacheText').textContent = Math.round(cacheRate) + '%';
            document.getElementById('cacheFill').style.width = cacheRate + '%';

            // 更新平均延迟
            const avgLatency = 50 + Math.random() * 50;
            document.getElementById('avgLatency').textContent = Math.round(avgLatency) + 'ms';

            // 更新吞吐量
            const throughput = 1000 + Math.random() * 500;
            document.getElementById('throughput').textContent = Math.round(throughput) + '/min';

            // 更新成功率
            const successRate = 95 + Math.random() * 4;
            document.getElementById('successRate').textContent = successRate.toFixed(1) + '%';
        }

        function simulateEvent() {
            if (!simulationRunning) return;

            eventCounter++;
            processingCounter++;
            updateStats();

            // 模拟处理延迟
            setTimeout(() => {
                processingCounter--;
                completedCounter++;
                updateStats();
                addLogEntry();
            }, Math.random() * 3000 + 500);

            // 更新指标
            updateMetrics();
        }

        // 事件监听器
        document.getElementById('startSimulation').addEventListener('click', () => {
            simulationRunning = true;
            document.getElementById('startSimulation').disabled = true;
            document.getElementById('stopSimulation').disabled = false;
            
            // 开始定期发送事件
            const interval = setInterval(() => {
                if (simulationRunning) {
                    simulateEvent();
                } else {
                    clearInterval(interval);
                }
            }, 2000);
        });

        document.getElementById('stopSimulation').addEventListener('click', () => {
            simulationRunning = false;
            document.getElementById('startSimulation').disabled = false;
            document.getElementById('stopSimulation').disabled = true;
        });

        document.getElementById('sendEvent').addEventListener('click', () => {
            simulateEvent();
        });

        // 新增的交互功能
        function updateLogSummary() {
            const logEntries = document.querySelectorAll('.log-entry');
            const totalEvents = logEntries.length;
            const completedEvents = document.querySelectorAll('.log-entry[data-status="completed"]').length;
            const successRate = totalEvents > 0 ? ((completedEvents / totalEvents) * 100).toFixed(1) : '0.0';
            
            // 计算平均延迟
            const latencyElements = document.querySelectorAll('.latency.good');
            let totalLatency = 0;
            let latencyCount = 0;
            latencyElements.forEach(el => {
                const latency = parseInt(el.textContent);
                if (!isNaN(latency)) {
                    totalLatency += latency;
                    latencyCount++;
                }
            });
            const avgLatency = latencyCount > 0 ? Math.round(totalLatency / latencyCount) : 0;

            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('avgLatency').textContent = avgLatency + 'ms';
        }

        // 清空日志
        document.getElementById('clearLog').addEventListener('click', () => {
            if (confirm('确定要清空所有日志记录吗？ / Are you sure you want to clear all log entries?')) {
                document.getElementById('logContent').innerHTML = '';
                updateLogSummary();
            }
        });

        // 导出数据
        document.getElementById('exportLog').addEventListener('click', () => {
            const logEntries = document.querySelectorAll('.log-entry');
            const data = Array.from(logEntries).map(entry => ({
                time: entry.querySelector('.time').textContent,
                eventType: entry.querySelector('.event-type').textContent.trim(),
                agent: entry.querySelector('.agent').textContent.trim(),
                status: entry.querySelector('.status').textContent.trim(),
                latency: entry.querySelector('.latency').textContent
            }));
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Time,Event Type,Agent,Status,Latency\n"
                + data.map(row => Object.values(row).join(',')).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "event_log_" + new Date().toISOString().split('T')[0] + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // 状态过滤
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            const filter = e.target.value;
            const entries = document.querySelectorAll('.log-entry');
            
            entries.forEach(entry => {
                if (filter === 'all' || entry.getAttribute('data-status') === filter) {
                    entry.style.display = 'grid';
                } else {
                    entry.style.display = 'none';
                }
            });
        });

        // 搜索功能
        document.getElementById('logSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const entries = document.querySelectorAll('.log-entry');
            
            entries.forEach(entry => {
                const eventType = entry.querySelector('.event-type').textContent.toLowerCase();
                const agent = entry.querySelector('.agent').textContent.toLowerCase();
                const status = entry.querySelector('.status').textContent.toLowerCase();
                
                if (eventType.includes(searchTerm) || agent.includes(searchTerm) || status.includes(searchTerm)) {
                    entry.style.display = 'grid';
                } else {
                    entry.style.display = 'none';
                }
            });
        });

        // 排序功能
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const sortBy = header.getAttribute('data-sort');
                const entries = Array.from(document.querySelectorAll('.log-entry'));
                
                entries.sort((a, b) => {
                    let aValue, bValue;
                    
                    switch(sortBy) {
                        case 'time':
                            aValue = a.querySelector('.time').textContent;
                            bValue = b.querySelector('.time').textContent;
                            return aValue.localeCompare(bValue);
                        case 'type':
                            aValue = a.querySelector('.event-type').textContent.trim();
                            bValue = b.querySelector('.event-type').textContent.trim();
                            return aValue.localeCompare(bValue);
                        case 'agent':
                            aValue = a.querySelector('.agent').textContent.trim();
                            bValue = b.querySelector('.agent').textContent.trim();
                            return aValue.localeCompare(bValue);
                        case 'status':
                            aValue = a.querySelector('.status').textContent.trim();
                            bValue = b.querySelector('.status').textContent.trim();
                            return aValue.localeCompare(bValue);
                        case 'latency':
                            aValue = parseInt(a.querySelector('.latency').textContent) || 0;
                            bValue = parseInt(b.querySelector('.latency').textContent) || 0;
                            return aValue - bValue;
                        default:
                            return 0;
                    }
                });
                
                const logContent = document.getElementById('logContent');
                entries.forEach(entry => logContent.appendChild(entry));
            });
        });

        // 事件详情查看
        function viewEventDetails(eventId) {
            alert(`查看事件详情 / View Event Details\n\n事件ID / Event ID: ${eventId}\n\n这里将显示事件的详细信息，包括：\n- 事件数据 / Event Data\n- 处理步骤 / Processing Steps\n- 性能指标 / Performance Metrics\n- 相关日志 / Related Logs`);
        }

        // 重放事件
        function replayEvent(eventId) {
            if (confirm(`确定要重放事件 ${eventId} 吗？ / Are you sure you want to replay event ${eventId}?`)) {
                simulateEvent();
                alert('事件已重放 / Event replayed successfully!');
            }
        }

        // 取消事件
        function cancelEvent(eventId) {
            if (confirm(`确定要取消事件 ${eventId} 吗？ / Are you sure you want to cancel event ${eventId}?`)) {
                // 找到对应的事件并更新状态
                const entries = document.querySelectorAll('.log-entry');
                entries.forEach(entry => {
                    const actionBtns = entry.querySelectorAll('.action-btn');
                    actionBtns.forEach(btn => {
                        if (btn.onclick && btn.onclick.toString().includes(eventId)) {
                            entry.querySelector('.status').innerHTML = '<span class="status-icon">❌</span> Cancelled';
                            entry.querySelector('.status').className = 'status cancelled';
                            entry.querySelector('.latency').textContent = '-';
                            entry.querySelector('.actions').innerHTML = '<button class="action-btn" onclick="viewEventDetails(\'' + eventId + '\')" title="查看详情 / View Details">👁️</button>';
                        }
                    });
                });
                updateLogSummary();
            }
        }

        // 优先处理事件
        function prioritizeEvent(eventId) {
            if (confirm(`确定要优先处理事件 ${eventId} 吗？ / Are you sure you want to prioritize event ${eventId}?`)) {
                // 找到对应的事件并移动到顶部
                const entries = document.querySelectorAll('.log-entry');
                entries.forEach(entry => {
                    const actionBtns = entry.querySelectorAll('.action-btn');
                    actionBtns.forEach(btn => {
                        if (btn.onclick && btn.onclick.toString().includes(eventId)) {
                            const logContent = document.getElementById('logContent');
                            logContent.insertBefore(entry, logContent.firstChild);
                            entry.querySelector('.status').innerHTML = '<span class="status-icon">⚡</span> Prioritized';
                            entry.querySelector('.status').className = 'status prioritized';
                        }
                    });
                });
                alert('事件已设置为优先处理 / Event prioritized successfully!');
            }
        }

        // 初始化
        updateStats();
        updateMetrics();
        updateLogSummary();
    </script>
</body>
</html>
